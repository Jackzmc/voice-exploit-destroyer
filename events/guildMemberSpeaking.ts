import { GuildMember, Speaking } from 'discord.js';
import Logger from '../src/Logger.js';
import Event from '../src/types/Event.js'
import { Client } from 'discord.js';

const MONITOR_CHANNELS = []

let pendingDisconnect: {[id: string]: boolean} = {};

enum ActionMode {
    BAN,
    DISCONNECT,
    KICK
}

export default class extends Event {
    #actionMode: ActionMode
    #actionReason: string

    constructor(client: Client, logger: Logger) {
        super(client, logger)
        if(!process.env.MONITOR_CHANNELS || process.env.MONITOR_CHANNELS.trim().length == 0) {
            this.logger.warn('No monitor channels have been setup.')
        }else{
            const channels = process.env.MONITOR_CHANNELS.split(",")
            channels.forEach(channel => MONITOR_CHANNELS.push(channel))
        }
        this.#actionMode = getAction()
        this.logger.info('Using action mode:', ActionMode[this.#actionMode])

        this.#actionReason = process.env.ACTION_REASON || "Mute Speaking Exploit"

    }

    async before() {
        return false;
    }
    
    after(member: GuildMember, speaking: Speaking) {
        const pending = pendingDisconnect[member.id]
        if(MONITOR_CHANNELS.includes(member.voice.channelID) && member.voice?.selfMute) {
            if(pending) {
                this.takeAction(member)
                delete pendingDisconnect[member.id]
            }else{
                pendingDisconnect[member.id] = true
            }
        }else if(pending) {
            delete pendingDisconnect[member.id]
        }
    }

    private async takeAction(member: GuildMember) {
        const botMember = member.guild.me
        switch(this.#actionMode) {
            case ActionMode.BAN: {
                if(botMember.permissions.has('BAN_MEMBERS')) {
                    return await member.ban({
                        reason: this.#actionReason
                    })
                }else{
                    this.logger.warn(`Bot does not have permission to ban ${member.id} (${member.voice.channel.name})`)
                }
            }

            case ActionMode.KICK: {
                if(botMember.permissions.has('KICK_MEMBERS')) {
                    return await member.kick(this.#actionReason)
                }else{
                    this.logger.warn(`Bot does not have permission to kick ${member.id} (${member.voice.channel.name})`)
                }
            }

            case ActionMode.DISCONNECT: {
                if(botMember.permissions.has('MOVE_MEMBERS')) {
                    return await member.voice.kick(this.#actionReason)
                }else{
                    this.logger.warn(`Bot does not have permission to disconnect ${member.id} in ${member.voice.channel.name}`)
                }
            }

            default: {
                this.logger.error('Unknown action mode was enabled, cannot take action on', member.id)
            }
        }
    }
}

function getAction() {
    if(!process.env.ACTION_MODE) return ActionMode.DISCONNECT
    switch(process.env.ACTION_MODE.toUpperCase()) {
        case "BAN": return ActionMode.BAN
        case "KICK": return ActionMode.KICK
        case "DISCONNECT": return ActionMode.DISCONNECT
        default: return ActionMode.DISCONNECT
    }
}