import { GuildMember, Speaking } from 'discord.js';
import Logger from '../src/Logger.js';
import Event from '../src/types/Event.js'
import { Client } from 'discord.js';

const MONITOR_CHANNELS = []

let pendingDisconnect: {[id: string]: boolean} = {};

export default class extends Event {

    constructor(client: Client, logger: Logger) {
        super(client, logger)
        if(!process.env.MONITOR_CHANNELS || process.env.MONITOR_CHANNELS.trim().length == 0) {
            this.logger.warn('No monitor channels have been setup.')
        }else{
            const channels = process.env.MONITOR_CHANNELS.split(",")
            channels.forEach(channel => MONITOR_CHANNELS.push(channel))
        }
    }

    async before() {
        return false;
    }
    after(member: GuildMember, speaking: Speaking) {
        const pending = pendingDisconnect[member.id]
        if(MONITOR_CHANNELS.includes(member.voice.channelID) && member.voice?.selfMute) {
            if(pending) {
                member.voice.kick('Bitch.')
                delete pendingDisconnect[member.id]
            }else{
                pendingDisconnect[member.id] = true
            }
        }else if(pending) {
            delete pendingDisconnect[member.id]
        }
    }
}